# RTOS_watering

Firmware and experiment scaffolding for RTS watering project.

# RTOS_watering

Firmware and experiment scaffolding for an ESP32-based watering controller used in RTS20242.

This README documents how to build, run, and evaluate the firmware, plus a detailed Real-Time Task Table (periods, WCET, deadlines, precedence, firmness) for your scheduling analysis deliverable.

Repository layout
- `src/` — firmware (`main.cpp`) implementing FreeRTOS tasks
- `platformio.ini` — build environments (`baseline`, `improved`)
- `scripts/` — log parsers and helper scripts
- `configs/` — experiment configuration files

Quick setup (local machine)
1. Create (optional) and activate a Python venv:
```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
```
2. Install PlatformIO CLI:
```powershell
python -m pip install --upgrade pip
pip install -U platformio
```
3. Build (do NOT embed secrets in the repo). Provide Supabase & weather keys at build time via `-D` flags:
```powershell
C:/path/to/.venv/Scripts/python.exe -m platformio run -e baseline -DSUPABASE_URL="https://<proj>.supabase.co" -DSUPABASE_KEY="<your_key>" -DWEATHER_API_KEY="<your_key>"
```
4. Upload & monitor:
```powershell
C:/path/to/.venv/Scripts/python.exe -m platformio run -e baseline -t upload
C:/path/to/.venv/Scripts/python.exe -m platformio device monitor -p COM3 -e baseline
```

Security
- Never commit API keys or service-role keys. Use build flags, environment-specific `platformio.ini.local` (gitignored), or CI secrets.
- For CI, store `SUPABASE_KEY` and `WEATHER_API_KEY` in repository secrets and inject them in workflows.

Supabase telemetry
The firmware posts telemetry to Supabase `telemetry` table. Example SQL to create a compatible table:
```sql
create table public.telemetry (
  id bigint generated by default as identity primary key,
  created_at timestamptz default now(),
  airtemp numeric,
  airhum numeric,
  forecasttemp numeric,
  forecasthum numeric,
  forecastlight numeric,
  forecast3temp numeric,
  forecast3hum numeric,
  forecast3light numeric,
  pumpon boolean,
  rainsoon boolean,
  nextirrigationms bigint,
  soil jsonb,
  valves jsonb
);
```

Instrumentation & measurement
- The firmware logs timing and deadline checks using `logTask()`; format:
  ```
  [<timestamp>ms] <Task> end duration=<d>ms deadline=<DL>ms HIT|MISS
  ```
- Use `scripts/parse_logs.py` to compute miss rates and latency percentiles.

Real-Time Task Table (detailed)

Legend:
- Period / Release — how often the task runs or how it is released.
- WCET — conservative worst-case execution time estimate (to be measured on-device).
- Deadline — the `DL_*` constant used by `logTask()` in code.
- Precedence — inputs or tasks that must complete first for fresh data.
- Firmness — `hard` (miss unacceptable), `firm` (miss degrades performance), `soft` (best-effort).

| Task            | Period / Release                 | WCET (est.) | Deadline (`DL_*`) | Precedence / Inputs                                 | Firmness |
|-----------------|----------------------------------:|------------:|------------------:|----------------------------------------------------|:--------:|
| SoilTask        | periodic, every 1000 ms           | 30–80 ms    | `DL_SOIL_MS` = 1000 ms  | none (provides `soilPct[]`)                         | firm     |
| DHTTask         | periodic, every 2000 ms           | 100–200 ms  | `DL_DHT_MS` = 2000 ms   | none (provides `airTemp`, `airHum`)                 | firm     |
| SwitchTask      | periodic decision, check every 1000 ms; scheduled irrigation events release asynchronously | 20–120 ms   | `DL_SWITCH_MS` = 1000 ms | depends on `soilPct[]`, `airTemp/airHum`, `forecast*`, `pumpOk/valveOk` | hard     |
| ErrorCheckTask  | periodic, every 5000 ms           | 80–300 ms   | `DL_ERROR_MS` = 5000 ms | uses feedback pins to set `pumpOk`/`valveOk`        | soft     |
| WeatherTask     | periodic, every 3600 s (1 h)      | 1–6 s (HTTP+parse) | `DL_WEATHER_MS` = 3600000 ms | networked HTTP call → updates `forecast*`, `rainSoon` | soft     |
| NetworkTask     | periodic send loop, admission control min interval 30 s | 200–2000 ms | `DL_NETWORK_MS` = 30000 ms | depends on `soilPct[]`, `airTemp`, `forecast*`, `valveOn[]` | soft     |
| DisplayTask     | periodic update (two-view cycle), ~3 s combined | 50–250 ms   | `DL_DISPLAY_MS` = 1000 ms | reads sensors + forecast + device state            | soft     |
| WatchdogTask    | periodic heartbeat, 2000 ms       | 5–20 ms     | `DL_WATCHDOG_MS` = 2000 ms | none                                              | hard     |

Notes and rationale
- `SwitchTask` controls actuation and is therefore the highest criticality: treat as `hard` in scheduling analysis. Ensure its input tasks (SoilTask, DHTTask) have sufficient priority and meet deadlines.
- `WeatherTask` is high-latency and infrequent; it provides advisory forecast values to improve scheduling decisions but is `soft`.
- `NetworkTask` is best-effort telemetry and should be throttled via `NETWORK_MIN_SEND_INTERVAL_MS` to avoid connectivity spikes.
- `ErrorCheckTask` improves safety by toggling relays briefly and reading feedback pins; when a device is flagged unhealthy the outputs are gated off by `applyOutputs()`.

How to measure and tune
1. Build and upload firmware, then capture serial logs (`platformio device monitor`).
2. Run `scripts/parse_logs.py` against the serial log to compute miss rates and latency percentiles.
3. Tune `DL_*` constants and task priorities in `src/main.cpp` and re-evaluate.

Collaboration and CI
- Invite collaborators via GitHub: Settings → Manage access (or `gh repo add-collaborator owner/repo user --permission write`).
- Add `SUPABASE_KEY` and `WEATHER_API_KEY` as GitHub Secrets for CI builds.

Optional additions I can implement for you:
- GitHub Actions workflow that builds `baseline` and `improved` (without secrets), runs static checks, and exposes artifacts.
- A `platformio.ini.local.example` template and a small `build-local.ps1` script that reads local secrets from a `.env` file.

---
Last updated: 2025-12-24
